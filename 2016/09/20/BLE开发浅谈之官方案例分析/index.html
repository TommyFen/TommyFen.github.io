<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>BluetoothGatt Sample 分析 | T+ 的小院</title><meta name="keywords" content="ble,Android"><meta name="author" content="T+"><meta name="copyright" content="T+"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Android BLE 入门理解学习的项目，托管在 Github 上，本篇文章将会对其进行一个详细的分析。">
<meta property="og:type" content="article">
<meta property="og:title" content="BluetoothGatt Sample 分析">
<meta property="og:url" content="https://tommyfen.cn/2016/09/20/BLE%E5%BC%80%E5%8F%91%E6%B5%85%E8%B0%88%E4%B9%8B%E5%AE%98%E6%96%B9%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="T+ 的小院">
<meta property="og:description" content="Android BLE 入门理解学习的项目，托管在 Github 上，本篇文章将会对其进行一个详细的分析。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tommyfen.cn/assets/img/avatar.png">
<meta property="article:published_time" content="2016-09-20T03:08:44.000Z">
<meta property="article:modified_time" content="2021-01-14T16:05:48.887Z">
<meta property="article:author" content="T+">
<meta property="article:tag" content="ble">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tommyfen.cn/assets/img/avatar.png"><link rel="shortcut icon" href="/assets/img/favicon-32x32-next.png"><link rel="canonical" href="https://tommyfen.cn/2016/09/20/BLE%E5%BC%80%E5%8F%91%E6%B5%85%E8%B0%88%E4%B9%8B%E5%AE%98%E6%96%B9%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2021-01-15 00:05:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/assets/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="no-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">T+ 的小院</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">BluetoothGatt Sample 分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2016-09-20T03:08:44.000Z" title="发表于 2016-09-20 11:08:44">2016-09-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-14T16:05:48.887Z" title="更新于 2021-01-15 00:05:48">2021-01-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E6%99%BA%E8%83%BD%E7%A1%AC%E4%BB%B6/">Android智能硬件</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p>话说我个人是做Android开发的，以前没做过关于蓝牙方面的开发。最近公司在做一个关于蓝牙4.0低功耗（BLE）的产品，前期的要求是写一个APP在手机或者平板上，要求能接收到BLE设备发出的数据然后显示在界面上。</p>
<p>相信看到这篇文章的人，或多或少都了解了BLE的特性和优点，我这里就不赘述了。</p>
<p>当时我查阅Google开发者文档有关于BLE的介绍时，它提到Google托管了一个关于BLE的Sample在GitHub上，因此我以这个叫做BluetoothLeGatt的Sample作为案例来进行对BLE的讲述。项目地址：<a target="_blank" rel="noopener" href="https://github.com/googlesamples/android-BluetoothLeGatt">BluetoothLeGattt</a></p>
<a id="more"></a>

<p>首先，明确哪一个Activity作为启动的活动，通过清单文件我们很容易看出是DeviceScanActivity。这个Activity主要目的是搜寻BLE设备，并通过列表条目（ListView）的形式来展现出来。</p>
<p>从onCreate方法开始，前面代码一系列都是判断你手机或者平板设备是否支持蓝牙,以及获得<strong>BluetoothAdapter</strong>这个类的实例（注意：这个实例挺重要的）。执行完onCreate方法之后，进入onResume()方法，其关键方法在于 <code>scanLeDevice(true);</code> 这个方法是自定义方法，该方法里面实现了BLE设备的搜索，看下面代码：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private void scanLeDevice(final boolean enable) &#123;</span><br><span class="line">	if (enable) &#123;</span><br><span class="line">    &#x2F;&#x2F;异步方法，表示延迟一定的时间之后执行其内部代码，</span><br><span class="line">    &#x2F;&#x2F;在该程序中，表示在10秒之后，停止手机或者平板扫描BLE设备的动作</span><br><span class="line">	    mHandler.postDelayed(new Runnable() &#123;</span><br><span class="line">	        @Override</span><br><span class="line">	        public void run() &#123;</span><br><span class="line">	            mScanning &#x3D; false;</span><br><span class="line">                mBluetoothAdapter.stopLeScan(mLeScanCallback);</span><br><span class="line">                invalidateOptionsMenu();</span><br><span class="line">	            &#125;</span><br><span class="line">        &#125;, SCAN_PERIOD);</span><br><span class="line">		mScanning &#x3D; true;</span><br><span class="line">        mBluetoothAdapter.startLeScan(mLeScanCallback);</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">	     mScanning &#x3D; false;</span><br><span class="line">         mBluetoothAdapter.stopLeScan(mLeScanCallback);</span><br><span class="line">     &#125;</span><br><span class="line">     invalidateOptionsMenu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>真正执行的扫描BLE设备的操作的是蓝牙适配器实例 <code>mBluethAdapter.startLeScan(mLeSacnCallback)</code> ，扫描到的设备都在这个方法的参数<em>mLeSacnCallback</em>这个回调里面进行处理，让我们来看一下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Device scan callback.</span><br><span class="line">   private BluetoothAdapter.LeScanCallback mLeScanCallback &#x3D;</span><br><span class="line">           new BluetoothAdapter.LeScanCallback() &#123;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onLeScan(final BluetoothDevice device, int rssi, byte[] scanRecord) &#123;</span><br><span class="line">           runOnUiThread(new Runnable() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               public void run() &#123;</span><br><span class="line">                   mLeDeviceListAdapter.addDevice(device);</span><br><span class="line">                   Log.i(TAG,&quot;添加一个设备&quot;);</span><br><span class="line">                   mLeDeviceListAdapter.notifyDataSetChanged();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p>这个回调中，将扫描到的设备，都添加到一个集合中去，然后以ListView的条目形式显示出来（Sample中将这个过程进行了封装，反正大概意思就这样，就像程序还有ActionBar中的选项的处理一样，不用在意这些细节，如果刻意的话，反而会增加你对这个案例的理解的难度）。</p>
<p>好啦，到这里，程序的设备搜索操作就完成了。设备信息也通过条目（包含名字和设备的物理地址）的形式显示下界面上了。点击条目，通过意图传递设备名称和物理地址跳转到下一个Activity中：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected void onListItemClick(ListView l, View v, int position, long id) &#123;</span><br><span class="line">        final BluetoothDevice device &#x3D; mLeDeviceListAdapter.getDevice(position);</span><br><span class="line">        if (device &#x3D;&#x3D; null) return;</span><br><span class="line">        final Intent intent &#x3D; new Intent(this, DeviceControlActivity.class);</span><br><span class="line">        intent.putExtra(DeviceControlActivity.EXTRAS_DEVICE_NAME, device.getName());</span><br><span class="line">        intent.putExtra(DeviceControlActivity.EXTRAS_DEVICE_ADDRESS, device.getAddress());</span><br><span class="line">        if (mScanning) &#123;</span><br><span class="line">            mBluetoothAdapter.stopLeScan(mLeScanCallback);</span><br><span class="line">            mScanning &#x3D; false;</span><br><span class="line">        &#125;</span><br><span class="line">        startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>跳转的同时，顺便停止扫描。。。。好吧，下一个<strong>DeviceControlActivity</strong>和<strong>BluetoothLeService</strong>两个才是这个Sample的核心内容，接着看。首先，在<strong>DeviceControlActivity</strong>中找到onCreate()生命周期方法：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">       super.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.gatt_services_characteristics);</span><br><span class="line"></span><br><span class="line">       final Intent intent &#x3D; getIntent();</span><br><span class="line">       mDeviceName &#x3D; intent.getStringExtra(EXTRAS_DEVICE_NAME);</span><br><span class="line">       mDeviceAddress &#x3D; intent.getStringExtra(EXTRAS_DEVICE_ADDRESS);</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F; Sets up UI references.</span><br><span class="line">       ((TextView) findViewById(R.id.device_address)).setText(mDeviceAddress);</span><br><span class="line">       mGattServicesList &#x3D; (ExpandableListView) findViewById(R.id.gatt_services_list);</span><br><span class="line">       mGattServicesList.setOnChildClickListener(servicesListClickListner);</span><br><span class="line">       mConnectionState &#x3D; (TextView) findViewById(R.id.connection_state);</span><br><span class="line">       mDataField &#x3D; (TextView) findViewById(R.id.data_value);</span><br><span class="line"></span><br><span class="line">       getActionBar().setTitle(mDeviceName);</span><br><span class="line">       getActionBar().setDisplayHomeAsUpEnabled(true);</span><br><span class="line">       Intent gattServiceIntent &#x3D; new Intent(this, BluetoothLeService.class);</span><br><span class="line">       &#x2F;&#x2F;将Activity和Services绑定,BIND_ATUO_CREATE表示活动和服务绑定后自动创建服务，这里会使得</span><br><span class="line">       &#x2F;&#x2F;Services的onCreate()方法得到执行，但不是执行onStartCommand()方法</span><br><span class="line">       bindService(gattServiceIntent, mServiceConnection, BIND_AUTO_CREATE);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>onCreate方法一旦启动，先把所传递过来的设备名称和设备的物理地址获取。进而看到通过意图来绑定服务（四大组件之一）， <strong>BluetoothLeService</strong> 是一个服务，后面许多操作将会在该服务执行。当然，还是一步步来，<em>bindService(gattServiceIntent, mServiceConnection, BIND_AUTO_CREATE)*（顺便看下注释）, *mServiceConnection</em> 是关键。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private final ServiceConnection mServiceConnection &#x3D; new ServiceConnection() &#123;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onServiceConnected(ComponentName componentName, IBinder service) &#123;</span><br><span class="line">           mBluetoothLeService &#x3D; ((BluetoothLeService.LocalBinder) service).getService();</span><br><span class="line">           if (!mBluetoothLeService.initialize()) &#123;</span><br><span class="line">               Log.e(TAG, &quot;Unable to initialize Bluetooth&quot;);</span><br><span class="line">               finish();</span><br><span class="line">           &#125;</span><br><span class="line">           &#x2F;&#x2F; Automatically connects to the device upon successful start-up initialization.</span><br><span class="line">           mBluetoothLeService.connect(mDeviceAddress);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onServiceDisconnected(ComponentName componentName) &#123;</span><br><span class="line">           mBluetoothLeService &#x3D; null;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p><em>ServiceConnection</em> 的实例里面重写了两个方法：<em>onServiceConnected()<em>和</em>onServiceDisconnect()*。分别表示连接服务成功和连接服务失败。在成功连接的方法里面：获取了 *</em>BluetoothLeService** 服务的实例，进而初始化，再而就是关键的 <em>connect(mDeviceAddress)</em> 方法，将上面获取到的设备物理地址作为参数传递过去。然后再进入该 <strong>BluetoothLeService</strong> 服务类中的 <em>connect()</em> 方法中来围观一下，揭开面纱：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public boolean connect(final String address) &#123;</span><br><span class="line">       if (mBluetoothAdapter &#x3D;&#x3D; null || address &#x3D;&#x3D; null) &#123;</span><br><span class="line">           Log.w(TAG, &quot;BluetoothAdapter not initialized or unspecified address.&quot;);</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F; Previously connected device.  Try to reconnect.</span><br><span class="line">       if (mBluetoothDeviceAddress !&#x3D; null &amp;&amp; address.equals(mBluetoothDeviceAddress)</span><br><span class="line">               &amp;&amp; mBluetoothGatt !&#x3D; null) &#123;</span><br><span class="line">           Log.d(TAG, &quot;Trying to use an existing mBluetoothGatt for connection.&quot;);</span><br><span class="line">           if (mBluetoothGatt.connect()) &#123;</span><br><span class="line">               mConnectionState &#x3D; STATE_CONNECTING;</span><br><span class="line">               return true;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               return false;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       final BluetoothDevice device &#x3D; mBluetoothAdapter.getRemoteDevice(address);</span><br><span class="line">       if (device &#x3D;&#x3D; null) &#123;</span><br><span class="line">           Log.w(TAG, &quot;Device not found.  Unable to connect.&quot;);</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line">       &#x2F;&#x2F; true表示自动连接，false表示立刻连接，好吧，应该明白哪个是你需要的了吧。</span><br><span class="line">       mBluetoothGatt &#x3D; device.connectGatt(this, false, mGattCallback);</span><br><span class="line">       Log.d(TAG, &quot;Trying to create a new connection.&quot;);</span><br><span class="line">       mBluetoothDeviceAddress &#x3D; address;</span><br><span class="line">       mConnectionState &#x3D; STATE_CONNECTING;</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>戳进来，前面又是一堆严谨的蓝牙是否可用判断……看到 <em>BluetoothDevice</em>，咳咳，肉戏终于来了！通过传递过来的设备物理地址address来获取期盼已久的 <em>BluetoothDevice</em> 的实例……什么，你问我 <em>mBluetoothAdapter</em> 在该服务里面什么时候进行的定义和赋值？！好吧，找了又找，原来是在 <strong>DeviceControlActivity</strong> 类中 <em>mServiceConnection</em> 实例中上面初始化方法 <em>initialize()</em> 里面进行了定义和赋值！！！请看：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public boolean initialize() &#123;</span><br><span class="line">       &#x2F;&#x2F; For API level 18 and above, get a reference to BluetoothAdapter through</span><br><span class="line">       &#x2F;&#x2F; BluetoothManager.</span><br><span class="line">       if (mBluetoothManager &#x3D;&#x3D; null) &#123;</span><br><span class="line">           mBluetoothManager &#x3D; (BluetoothManager) getSystemService(Context.BLUETOOTH_SERVICE);</span><br><span class="line">           if (mBluetoothManager &#x3D;&#x3D; null) &#123;</span><br><span class="line">               Log.e(TAG, &quot;Unable to initialize BluetoothManager.&quot;);</span><br><span class="line">               return false;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mBluetoothAdapter &#x3D; mBluetoothManager.getAdapter();&#x2F;&#x2F;I am here！</span><br><span class="line">       if (mBluetoothAdapter &#x3D;&#x3D; null) &#123;</span><br><span class="line">           Log.e(TAG, &quot;Unable to obtain a BluetoothAdapter.&quot;);</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>是不是很坑！！对！就是那么坑！刚才说到获取了 <em>BluetoothDevice</em> 这个关键类的实例device，然后 <em>mBluetoothGatt = device.connectGatt(this, false, mGattCallback)<em>，终于建立了手机与设备的联系。那么真真的关键就来了，就在</em>mGattCallback</em>这个回调实例中。许多和蓝牙设备的交互就是从这实例中完成的。戳进这个实例来看：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;实现应用程序所关心的GATT事件的接口回调方法，比如：连接的状态，服务的发现等</span><br><span class="line">   private final BluetoothGattCallback mGattCallback &#x3D; new BluetoothGattCallback() &#123;</span><br><span class="line">       @Override</span><br><span class="line">       public void onConnectionStateChange(BluetoothGatt gatt, int status, int newState) &#123;</span><br><span class="line">           String intentAction;</span><br><span class="line">           if (newState &#x3D;&#x3D; BluetoothProfile.STATE_CONNECTED) &#123;</span><br><span class="line">               intentAction &#x3D; ACTION_GATT_CONNECTED;</span><br><span class="line">               mConnectionState &#x3D; STATE_CONNECTED;</span><br><span class="line">                   broadcastUpdate(intentAction);</span><br><span class="line">               Log.i(TAG, &quot;Connected to GATT server.&quot;);</span><br><span class="line">               &#x2F;&#x2F; Attempts to discover services after successful connection.</span><br><span class="line">               &#x2F;&#x2F;尝试发现服务在成功连接之后</span><br><span class="line">               Log.i(TAG, &quot;Attempting to start service discovery:&quot; +</span><br><span class="line">                       mBluetoothGatt.discoverServices());</span><br><span class="line"></span><br><span class="line">           &#125; else if (newState &#x3D;&#x3D; BluetoothProfile.STATE_DISCONNECTED) &#123;</span><br><span class="line">               intentAction &#x3D; ACTION_GATT_DISCONNECTED;</span><br><span class="line">               mConnectionState &#x3D; STATE_DISCONNECTED;</span><br><span class="line">               Log.i(TAG, &quot;Disconnected from GATT server.&quot;);</span><br><span class="line">               broadcastUpdate(intentAction);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onServicesDiscovered(BluetoothGatt gatt, int status) &#123;</span><br><span class="line">           if (status &#x3D;&#x3D; BluetoothGatt.GATT_SUCCESS) &#123;</span><br><span class="line">               broadcastUpdate(ACTION_GATT_SERVICES_DISCOVERED);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               Log.w(TAG, &quot;onServicesDiscovered received: &quot; + status);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onCharacteristicRead(BluetoothGatt gatt,</span><br><span class="line">                                        BluetoothGattCharacteristic characteristic,</span><br><span class="line">                                        int status) &#123;</span><br><span class="line">           if (status &#x3D;&#x3D; BluetoothGatt.GATT_SUCCESS) &#123;</span><br><span class="line">               broadcastUpdate(ACTION_DATA_AVAILABLE, characteristic);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onCharacteristicChanged(BluetoothGatt gatt,</span><br><span class="line">                                           BluetoothGattCharacteristic characteristic) &#123;</span><br><span class="line">           broadcastUpdate(ACTION_DATA_AVAILABLE, characteristic);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>该回调实例重写了四个方法。</p>
<ul>
<li><p>第一个重写的方法 <strong>onContectionStateChange</strong> 方法，根据其参数newState，判断手机是否和蓝牙设备连接是否成功，然后执行发送广播的操作（封装在 <code>broadcastUpdate()</code> 方法中）。执行该方法的情景：当手机试图与蓝牙设备进行连接的时候的执行该方法。</p>
</li>
<li><p>第二个重写的方法 <strong>onServiceDiscovered</strong>，表示发现设备中的服务（ps：设备中的服务和特征还有uuid另外查询概念，现在可以理解设备的服务是一辆客车，特征就是乘客，uuid是车牌。而乘客中有我们所需要的数据（比喻来《低功耗蓝牙开发权威指南》）），如果成功发现了服务，就执行发送广播的操作。执行该方法的情景：当手机发现蓝牙设备的服务时候。</p>
</li>
<li><p>第三个重写的方法 <strong>onCharacteristicRead</strong> 方法，执行的是特征（characteristic）读操作，然后执行发送广播的操作，这个操作和上述的操作不同，等下戳进去观察一下。执行该方法的情景：调用 <code>mBluetoothGatt.readCharacteristic(characteristic)</code> 方法的时候执行。</p>
</li>
<li><p>第四个重写的方法 <strong>onCharacteristicChange</strong> 方法，是当蓝牙设备内部的特征（characteristic）发生变化是执行的操作方法。方法中执行重载的发送广播的方法。我们结合第三重写方法来观察一下这个方法。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void broadcastUpdate(final String action,final BluetoothGattCharacteristic characteristic) &#123;</span><br><span class="line">        final Intent intent &#x3D; new Intent(action);</span><br><span class="line">        &#x2F;&#x2F;这是给心率测量规范的特殊处理，数据解析是根据配置文件进行规范的</span><br><span class="line">        if (UUID_HEART_RATE_MEASUREMENT.equals(characteristic.getUuid())) &#123;</span><br><span class="line">            int flag &#x3D; characteristic.getProperties();</span><br><span class="line">            int format &#x3D; -1;</span><br><span class="line">            if ((flag &amp; 0x01) !&#x3D; 0) &#123;</span><br><span class="line">                format &#x3D; BluetoothGattCharacteristic.FORMAT_UINT16;</span><br><span class="line">                Log.d(TAG, &quot;Heart rate format UINT16.&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                format &#x3D; BluetoothGattCharacteristic.FORMAT_UINT8;</span><br><span class="line">                Log.d(TAG, &quot;Heart rate format UINT8.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            final int heartRate &#x3D; characteristic.getIntValue(format, 1);</span><br><span class="line">            Log.d(TAG, String.format(&quot;Received heart rate: %d&quot;, heartRate));</span><br><span class="line">            intent.putExtra(EXTRA_DATA, String.valueOf(heartRate));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; For all other profiles, writes the data formatted in HEX.</span><br><span class="line">            &#x2F;&#x2F;如果不是心率测量的规范，将数据转化为16进制的数据</span><br><span class="line">            final byte[] data &#x3D; characteristic.getValue();</span><br><span class="line">            if (data !&#x3D; null &amp;&amp; data.length &gt; 0) &#123;</span><br><span class="line">                final StringBuilder stringBuilder &#x3D; new StringBuilder(data.length);</span><br><span class="line">                for(byte byteChar : data)</span><br><span class="line">                    stringBuilder.append(String.format(&quot;%02X &quot;, byteChar));</span><br><span class="line">		            intent.putExtra(EXTRA_DATA, new String(data) + &quot;\n&quot; + stringBuilder.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sendBroadcast(intent);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个封装的方法，大概就是从特征（characteristic）中获取蓝牙传递过来的数据。但是一个蓝牙设备中有许多个服务，一个服务中又包含了一个或者多个特征，特征下面才是需要的获得的数据，那么该如何做出区分呢？这是就要用到UUID这个概念，但是详细介绍需要许多的篇幅，因此在这就认为它是一个车牌号，用来寻找指定特征（characteristic）的标识。看方法代码：判断特征的UUID是否心率测量的UUID是否相等（心率测量有指定的profile，本文并不关心，若想了解可以查阅部分资料和蓝牙开发者门户网站），若相等根据指定的心率解析规范（profile）进行解析。若不相等，当做一般的数据来进行解析（本文侧重一般解析）。一般解析中，很明显就是byte[] data就是蓝牙设备中传递过来的数据——一个字节数组，然后将数组转换成字符串。通过Intent将数据携带，然后发送广播。</p>
<p>既然广播已经发出，那肯定有接收广播的一方，回到 <strong>DeviceControlActivity</strong> 中，在那里已经 <strong>动态注册</strong> 了广播接收者（四大组件之一）了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private final BroadcastReceiver mGattUpdateReceiver &#x3D; new BroadcastReceiver() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">            final String action &#x3D; intent.getAction();</span><br><span class="line">            if (BluetoothLeService.ACTION_GATT_CONNECTED.equals(action)) &#123;</span><br><span class="line">                mConnected &#x3D; true;</span><br><span class="line">                updateConnectionState(R.string.connected);</span><br><span class="line">                invalidateOptionsMenu();</span><br><span class="line">            &#125; else if (BluetoothLeService.ACTION_GATT_DISCONNECTED.equals(action)) &#123;</span><br><span class="line">                mConnected &#x3D; false;</span><br><span class="line">                updateConnectionState(R.string.disconnected);</span><br><span class="line">                invalidateOptionsMenu();</span><br><span class="line">                clearUI();</span><br><span class="line">            &#125; else if (BluetoothLeService.ACTION_GATT_SERVICES_DISCOVERED.equals(action)) &#123;</span><br><span class="line">                &#x2F;&#x2F; Show all the supported services and characteristics on the user interface.</span><br><span class="line">                &#x2F;&#x2F;显示所有的被支持的服务和属性在用户的界面上</span><br><span class="line">                displayGattServices(mBluetoothLeService.getSupportedGattServices());</span><br><span class="line">            &#125; else if (BluetoothLeService.ACTION_DATA_AVAILABLE.equals(action)) &#123;</span><br><span class="line">                displayData(intent.getStringExtra(BluetoothLeService.EXTRA_DATA));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> registerReceiver(mGattUpdateReceiver, makeGattUpdateIntentFilter());</span><br></pre></td></tr></table></figure>
<p>根据已经过滤好的动作，进行不同的判断，来分别做不同操作。</p>
</li>
</ul>
<ul>
<li><p><strong>BluetoothLeService.ACTION_GATT_CONNECTED</strong> 是手机和蓝牙设备连接上的动作，表示手机和蓝牙设备已经处在连接的状态，然后将已连接状态显示在界面上。</p>
</li>
<li><p><strong>BluetoothLeService.ACTION_GATT_DISCONNECTED</strong> 是手机和蓝牙设备没有连接的动作，表示手机和蓝牙设备处在无连接的状态，然后将未连接的状态显示在界面上。</p>
</li>
<li><p><strong>BluetoothLeService.ACTION_GATT_SERVICES_DISCOVERED</strong> 是发现蓝牙设备服务（service）的动作，<code>mBluetoothLeService.getSupportedGattServices()</code> 方法是得到一个服务的集合，然后将这个蓝牙设备所有的服务的集合作为参数传递，然后 <code>displayGattServices()</code> 这个方法，是将这个蓝牙设备所有的服务和服务下面的特性用 ExpendListView（二级结构列表）显示在界面上，而点击服务条目就展开该服务所在的所有特性，点击特征目录则显示数据在上方。</p>
</li>
<li><p><strong>BluetoothLeService.ACTION_DATA_AVAILABLE</strong> 是读取特征（characteristic）和特征变化时的动作，并且将从特征得到的数据通过Intent返回，然后显示在界面上。   </p>
</li>
</ul>
<p>接下来，就是关于2级条目的点击事件，里面包含了触发 <em>mGattCallback</em> 中读取属性的状态和一旦属性特征变化的onCharacteristicChange方法的触发事件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private final ExpandableListView.OnChildClickListener servicesListClickListner &#x3D;</span><br><span class="line">           new ExpandableListView.OnChildClickListener() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               public boolean onChildClick(ExpandableListView parent, View v, int groupPosition,</span><br><span class="line">                                           int childPosition, long id) &#123;</span><br><span class="line">                   if (mGattCharacteristics !&#x3D; null) &#123;</span><br><span class="line">                       &#x2F;&#x2F;获得的是BluetoothGattCharacteristic</span><br><span class="line">                       final BluetoothGattCharacteristic characteristic &#x3D;</span><br><span class="line">                               mGattCharacteristics.get(groupPosition).get(childPosition);</span><br><span class="line">                       final int charaProp &#x3D; characteristic.getProperties();</span><br><span class="line">                       if ((charaProp | BluetoothGattCharacteristic.PROPERTY_READ) &gt; 0) &#123;</span><br><span class="line">                           &#x2F;&#x2F; If there is an active notification on a characteristic, clear</span><br><span class="line">                           &#x2F;&#x2F; it first so it doesn&#39;t update the data field on the user interface.</span><br><span class="line">                           &#x2F;&#x2F;假如有一个活跃的notification在characteristic中，首先先清理它，因</span><br><span class="line">                           &#x2F;&#x2F;为它不会在用户的界面上更新数据字段</span><br><span class="line">                           if (mNotifyCharacteristic !&#x3D; null) &#123;</span><br><span class="line">                               mBluetoothLeService.setCharacteristicNotification(</span><br><span class="line">                                       mNotifyCharacteristic, false);</span><br><span class="line">                               mNotifyCharacteristic &#x3D; null;</span><br><span class="line">                           &#125;</span><br><span class="line">                           mBluetoothLeService.readCharacteristic(characteristic);</span><br><span class="line">                       &#125;</span><br><span class="line">                       if ((charaProp | BluetoothGattCharacteristic.PROPERTY_NOTIFY) &gt; 0) &#123;</span><br><span class="line">                           mNotifyCharacteristic &#x3D; characteristic;</span><br><span class="line">                           mBluetoothLeService.setCharacteristicNotification(</span><br><span class="line">                                   characteristic, true);</span><br><span class="line">                       &#125;</span><br><span class="line">                       return true;</span><br><span class="line">                   &#125;</span><br><span class="line">                   return false;</span><br><span class="line">               &#125;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p>方法里面，首先是获得被点击的是的特征（Characteristic）是哪一个，进而进行判断（看注释），在于 <code>setCharacteristicNotification()</code> 方法，它用于该特征的数据变化时进行同步的更新和变化，以及 <code>readCharacteristic(characteristic)</code> 方法，读取属性的方法。先进入 <code>readCharacteristic(characteristic)</code> 方法进行观察：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void readCharacteristic(BluetoothGattCharacteristic characteristic) &#123;</span><br><span class="line">       if (mBluetoothAdapter &#x3D;&#x3D; null || mBluetoothGatt &#x3D;&#x3D; null) &#123;</span><br><span class="line">           Log.w(TAG, &quot;BluetoothAdapter not initialized&quot;);</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       mBluetoothGatt.readCharacteristic(characteristic);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>方法很明显，<code>mBluetoothGatt.readCharacteristic(characteristic)</code> 就是读取属性的方法，该方法调用之后，就会触发 <em>mGattCallback</em> 回调中的 <code>onCharacteristicRead()</code> 方法，然后在 <code>onCharacteristicRead()</code> 方法中发送广播。 而 <code>setCharacteristicNOtification()</code> 方法主要用于当该特征在蓝牙设备上的数据进行了变化的时候，程序中能够通知更新。看代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void setCharacteristicNotification(BluetoothGattCharacteristic characteristic,</span><br><span class="line">                                             boolean enabled) &#123;</span><br><span class="line">       if (mBluetoothAdapter &#x3D;&#x3D; null || mBluetoothGatt &#x3D;&#x3D; null) &#123;</span><br><span class="line">           Log.w(TAG, &quot;BluetoothAdapter not initialized&quot;);</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       mBluetoothGatt.setCharacteristicNotification(characteristic, enabled);</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F; This is specific to Heart Rate Measurement.</span><br><span class="line">       &#x2F;&#x2F;这是特定的，是心率的测量的处理</span><br><span class="line">       if (UUID_HEART_RATE_MEASUREMENT.equals(characteristic.getUuid())) &#123;</span><br><span class="line">           BluetoothGattDescriptor descriptor &#x3D; characteristic.getDescriptor(</span><br><span class="line">                   UUID.fromString(SampleGattAttributes.CLIENT_CHARACTERISTIC_CONFIG));</span><br><span class="line">           descriptor.setValue(BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE);</span><br><span class="line">           mBluetoothGatt.writeDescriptor(descriptor);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>方法里面直接一句 <code>mBluetoothGatt.setCharacteristicNotification(characteristic, enabled)</code> 就完成了通知更新？！NO！后面才是重点，首先先过滤出你想要实时更新的特征（Characteristic），然后设置描述（Descriptor），然后 <code>writeDescriptor(descriptor)</code>，这样该特征才会通知更新。所以，有些人没注意这些细节，连通蓝牙设备之后运行完该程序之后，就会奇怪为什么我点击的特性的值为什么没有通知同步更新，而在该特征下蓝牙设备上发送的数据的确是不同的，问题在于：该程序的只设定了心率的那个UUID下特性的通知更新，就是刚才所述的代码，若要指定某个特征进行通知更新就要重新设置描述，以及然后 <code>writeDescriptor(descriptor)</code>。哦，还有一点，<strong>CLIENT_CHARACTERISTIC_CONFIG</strong> 是特性通用的uuid，一般情况下是固定不变的。</p>
<p>好了，说到这里，差不多整个Sample就差不多讲完了，还有关闭连接，关闭服务的一些细节可以参考官方给出的文档。</p>
<p>在该文的末尾，来捋一遍程序代码的思路。</p>
<ol>
<li><p>扫描蓝牙设备，然后通过条目形式展示搜索到的设备。点击条目，将设备名称和物理地址传递到下一个活动当中。</p>
</li>
<li><p> 绑定服务，在绑定服务的参数中 <em>ServiceConnection</em> 的实例中的方法中，获取自定义服务的实例，根据服务实例调用 <code>connect()</code> 方法，将设备的物理地址传递过去。</p>
</li>
<li><p><code>connect()</code> 方法目的是根据设备的物理地址，连接到蓝牙设备上GATT服务，该过程中，有个 <em>GattCallBack</em> 回调，该回调完成了连接设备、发现服务、读取特征，数据变化通知更新等操作，然后通过广播的形式将操作结果返回到活动中去。</p>
</li>
<li><p>自定广播接收者，设置过滤，将广播的内容的获取，然后进行相应的处理。  </p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">T+</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://tommyfen.cn/2016/09/20/BLE%E5%BC%80%E5%8F%91%E6%B5%85%E8%B0%88%E4%B9%8B%E5%AE%98%E6%96%B9%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/">https://tommyfen.cn/2016/09/20/BLE%E5%BC%80%E5%8F%91%E6%B5%85%E8%B0%88%E4%B9%8B%E5%AE%98%E6%96%B9%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://tommyfen.cn" target="_blank">T+ 的小院</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ble/">ble</a><a class="post-meta__tags" href="/tags/Android/">Android</a></div><div class="post_share"><div class="social-share" data-image="/assets/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2016/10/13/Android%E4%B8%AD%E7%9A%84%E5%8F%AF%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android中的可存储路径</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2018/01/26/BLE-API分析/" title="BLE API分析"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-01-26</div><div class="title">BLE API分析</div></div></a></div><div><a href="/2017/12/15/Bluetooth-Low-Energy/" title="Bluetooth-Low_Energy"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-12-15</div><div class="title">Bluetooth-Low_Energy</div></div></a></div><div><a href="/2016/10/13/Android中的可存储路径/" title="Android中的可存储路径"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-10-13</div><div class="title">Android中的可存储路径</div></div></a></div><div><a href="/2018/03/13/DialogFragment详解/" title="DialogFragment详解"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-13</div><div class="title">DialogFragment详解</div></div></a></div><div><a href="/2018/02/23/Fragment概要篇/" title="Fragment概要篇"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-02-23</div><div class="title">Fragment概要篇</div></div></a></div><div><a href="/2017/11/26/Service的绑定小结/" title="Service的绑定小结"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-11-26</div><div class="title">Service的绑定小结</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/assets/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">T+</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/tommyfen" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://stackoverflow.com/users/7455574/tommy" target="_blank" title="StackOverflow"><i class="fab fa-stack-overflow"></i></a></div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2018/04/09/TextView-%E5%8F%8A%E5%85%B6%E5%AD%90%E7%B1%BB%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E4%BD%93%E6%A0%B7%E5%BC%8F/" title="TextView 及其子类自定义字体样式">TextView 及其子类自定义字体样式</a><time datetime="2018-04-09T14:11:51.000Z" title="发表于 2018-04-09 22:11:51">2018-04-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2018/03/13/DialogFragment%E8%AF%A6%E8%A7%A3/" title="DialogFragment详解">DialogFragment详解</a><time datetime="2018-03-13T14:35:17.000Z" title="发表于 2018-03-13 22:35:17">2018-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2018/02/23/Fragment%E6%A6%82%E8%A6%81%E7%AF%87/" title="Fragment概要篇">Fragment概要篇</a><time datetime="2018-02-23T14:09:02.000Z" title="发表于 2018-02-23 22:09:02">2018-02-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2018/01/26/BLE-API%E5%88%86%E6%9E%90/" title="BLE API分析">BLE API分析</a><time datetime="2018-01-26T14:25:52.000Z" title="发表于 2018-01-26 22:25:52">2018-01-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2017/12/15/Bluetooth-Low-Energy/" title="Bluetooth-Low_Energy">Bluetooth-Low_Energy</a><time datetime="2017-12-15T14:17:15.000Z" title="发表于 2017-12-15 22:17:15">2017-12-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By T+</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>